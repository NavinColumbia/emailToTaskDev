{% extends "base.html" %}

{% block title %}Fetch Emails - Taskflow{% endblock %}

{% block content %}
<div class="notion-slide-up">
    <div class="notion-card">
        <div class="notion-card-header">
            <h1 class="notion-card-title">
                <i class="bi bi-download notion-icon" style="color: var(--notion-accent);"></i>
                Fetch and Process Emails
            </h1>
            <p class="notion-card-subtitle">Configure your search parameters and process emails from your Gmail account.</p>
        </div>
        
        <form id="fetchForm" class="notion-mb-xl" method="post" action="/api/fetch-emails">
            <div class="notion-grid notion-grid-4">
              <!-- Provider -->
              <div class="notion-form-group">
                <label for="provider" class="notion-label">Task Provider</label>
                <select class="notion-select" id="provider" name="provider">
                  <option value="google_tasks" selected>Google Tasks</option>
                </select>
              </div>
          
             <!--              
              <div class="notion-form-group">
                <label for="label" class="notion-label">Gmail Label (optional)</label>
                <input type="text" class="notion-input" id="label" name="label" value="todoist-forward" placeholder="Gmail label">
              </div> -->
          
              <!-- Max -->
              <div class="notion-form-group">
                <label for="max" class="notion-label">Max Emails</label>
                <input type="number" class="notion-input" id="max" name="max" min="1" placeholder="(blank = all)">
                
              </div>
          
              <!-- Gmail newer_than coarse window -->
              <div class="notion-form-group">
                <label for="window" class="notion-label">Gmail Window (coarse)</label>
                <select class="notion-select" id="window" name="window">
                  <option value="">All emails</option>
                  <option value="1d">Last 24 hours</option>
                  <option value="7d">Last 7 days</option>
                  <option value="30d">Last 30 days</option>
                </select>
              </div>
            </div>
          
            <div class="notion-grid notion-grid-4" style="margin-top: var(--notion-space-md);">
              <!-- 
              <div class="notion-form-group">
                <label for="use_label" class="notion-label">Use Label?</label>
                <select class="notion-select" id="use_label" name="use_label">
                  <option value="true" selected>Yes</option>
                  <option value="false">No (search all mail)</option>
                </select>
              </div> -->
          
              <!-- Since hours (precise) -->
              <div class="notion-form-group">
                <label for="since_hours" class="notion-label">Since (hours)</label>
                <input type="number" class="notion-input" id="since_hours" name="since_hours" placeholder="e.g., 24">
              </div>
          
              <!-- Since ISO (precise override) -->
              <div class="notion-form-group">
                <label for="since" class="notion-label">Since (ISO 8601)</label>
                <input type="text" class="notion-input" id="since" name="since" placeholder="e.g., 2025-10-27T12:00:00Z">
                <div class="notion-help">Overrides hours if both provided.</div>
              </div>
          
              <!-- Dry run -->
              <div class="notion-form-group">
                <label for="dry_run" class="notion-label">Dry Run</label>
                <select class="notion-select" id="dry_run" name="dry_run">
                  <option value="false" selected>No</option>
                  <option value="true">Yes</option>
                </select>
              </div>
            </div>
          
            <div class="notion-grid notion-grid-1" style="margin-top: var(--notion-space-md);">
              <!-- Custom Gmail query -->
              <div class="notion-form-group">
                <label for="q" class="notion-label">Custom Gmail Query</label>
                <input type="text" class="notion-input" id="q" name="q" placeholder='e.g., from:boss@example.com has:attachment'>
                <div class="notion-help">If provided, this overrides the label unless you include it in your query.</div>
              </div>
            </div>
          
            <div class="notion-flex notion-gap-md">
              <button type="submit" class="notion-btn notion-btn-primary notion-btn-lg" id="fetchBtn">
                <i class="bi bi-download notion-icon"></i> Process Emails â†’ Create Tasks
              </button>
            </div>
          
            <div id="error" class="notion-alert notion-alert-error notion-hidden" style="margin-top: var(--notion-space-md);">
              <i class="bi bi-exclamation-triangle notion-icon"></i>
              <div>
                <h4>Error</h4>
                <div id="errorContent"></div>
              </div>
            </div>
          </form>
          
          

        <div id="error" class="notion-alert notion-alert-error notion-hidden">
            <i class="bi bi-exclamation-triangle notion-icon"></i>
            <div>
                <h4>Error</h4>
                <div id="errorContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load saved settings on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedSettings = localStorage.getItem('emailToTaskSettings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        Object.keys(settings).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                element.value = settings[key];
            }
        });
    }
});

</script>
{% endblock %}
